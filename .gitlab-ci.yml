# GitLab CI/CD Pipeline for robotframework-chat
# This pipeline runs the full Robot Framework test suite for LLM testing
# Requires GitLab runner with Ollama installed locally

stages:
  - lint
  - test
  - report

variables:
  # Ollama configuration
  OLLAMA_ENDPOINT: "http://localhost:11434"
  DEFAULT_MODEL: "llama3"

  # Test configuration
  ROBOT_OPTIONS: "--metadata CI:true --metadata GitLab_URL:$CI_PROJECT_URL --metadata Commit_SHA:$CI_COMMIT_SHA"

# Default image
image: python:3.11-slim

# Cache uv dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .venv/

# =============================================================================
# LINT STAGE
# =============================================================================

pre-commit:
  stage: lint
  before_script:
    - apt-get update && apt-get install -y git
    - pip install uv pre-commit
    - uv sync
  script:
    - uv run pre-commit run --all-files
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

ruff-check:
  stage: lint
  before_script:
    - pip install uv
    - uv sync
  script:
    - uv run ruff check .
    - uv run ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

mypy-check:
  stage: lint
  before_script:
    - pip install uv
    - uv sync
  script:
    - uv run mypy src/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# TEST STAGE - Only runs on runners with 'ollama' tag
# =============================================================================

.robot_template: &robot_template
  tags:
    - ollama
  before_script:
    - pip install uv
    - uv sync
    - |
      echo "Checking Ollama at $OLLAMA_ENDPOINT..."
      curl -s "$OLLAMA_ENDPOINT/api/tags" > /dev/null || (echo "❌ Ollama not available" && exit 1)
      echo "✅ Ollama is available"
    - |
      echo "Checking model: $DEFAULT_MODEL"
      curl -s -X POST "$OLLAMA_ENDPOINT/api/pull" -d "{\"name\": \"$DEFAULT_MODEL\"}" || true

robot-math-tests:
  stage: test
  <<: *robot_template
  script:
    - |
      uv run robot \
        -d results/math \
        -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT \
        -v DEFAULT_MODEL:$DEFAULT_MODEL \
        --metadata "Test Suite:Math" \
        --metadata "Model:$DEFAULT_MODEL" \
        --metadata "GitLab Project:$CI_PROJECT_URL" \
        --metadata "GitLab Commit:$CI_COMMIT_SHA" \
        --metadata "GitLab Branch:$CI_COMMIT_REF_NAME" \
        --metadata "GitLab Pipeline:$CI_PIPELINE_URL" \
        --metadata "Runner ID:$CI_RUNNER_ID" \
        --metadata "Runner Description:$CI_RUNNER_DESCRIPTION" \
        --metadata "Timestamp:$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        robot/math/tests/
  artifacts:
    when: always
    paths:
      - results/math/log.html
      - results/math/output.xml
      - results/math/report.html
    reports:
      junit: results/math/output.xml
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

robot-docker-tests:
  stage: test
  tags:
    - ollama
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache python3 py3-pip git curl
    - pip install uv
    - uv sync
    - docker info
    - |
      echo "Checking Ollama at $OLLAMA_ENDPOINT..."
      curl -s "$OLLAMA_ENDPOINT/api/tags" > /dev/null || (echo "❌ Ollama not available" && exit 1)
      echo "✅ Ollama is available"
  script:
    - |
      uv run robot \
        -d results/docker \
        -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT \
        -v DEFAULT_MODEL:$DEFAULT_MODEL \
        --metadata "Test Suite:Docker" \
        --metadata "Model:$DEFAULT_MODEL" \
        --metadata "GitLab Project:$CI_PROJECT_URL" \
        --metadata "GitLab Commit:$CI_COMMIT_SHA" \
        --metadata "GitLab Branch:$CI_COMMIT_REF_NAME" \
        --metadata "GitLab Pipeline:$CI_PIPELINE_URL" \
        --metadata "Runner ID:$CI_RUNNER_ID" \
        --metadata "Runner Description:$CI_RUNNER_DESCRIPTION" \
        --metadata "Timestamp:$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        robot/docker/
  artifacts:
    when: always
    paths:
      - results/docker/log.html
      - results/docker/output.xml
      - results/docker/report.html
    reports:
      junit: results/docker/output.xml
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

robot-safety-tests:
  stage: test
  <<: *robot_template
  script:
    - |
      uv run robot \
        -d results/safety \
        -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT \
        -v DEFAULT_MODEL:$DEFAULT_MODEL \
        --metadata "Test Suite:Safety" \
        --metadata "Model:$DEFAULT_MODEL" \
        --metadata "Ollama Endpoint:$OLLAMA_ENDPOINT" \
        --metadata "GitLab Project:$CI_PROJECT_URL" \
        --metadata "GitLab Commit:$CI_COMMIT_SHA" \
        --metadata "GitLab Branch:$CI_COMMIT_REF_NAME" \
        --metadata "GitLab Pipeline:$CI_PIPELINE_URL" \
        --metadata "Runner ID:$CI_RUNNER_ID" \
        --metadata "Runner Description:$CI_RUNNER_DESCRIPTION" \
        --metadata "Timestamp:$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        robot/safety/
  artifacts:
    when: always
    paths:
      - results/safety/log.html
      - results/safety/output.xml
      - results/safety/report.html
    reports:
      junit: results/safety/output.xml
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# =============================================================================
# REPORT STAGE
# =============================================================================

aggregate-results:
  stage: report
  needs:
    - job: robot-math-tests
      artifacts: true
      optional: true
    - job: robot-docker-tests
      artifacts: true
      optional: true
    - job: robot-safety-tests
      artifacts: true
      optional: true
  before_script:
    - pip install uv
    - uv sync
  script:
    - mkdir -p results/aggregated
    - uv run python scripts/generate_ci_metadata.py || echo "Metadata generation skipped"
  artifacts:
    when: always
    paths:
      - results/aggregated/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
