# GitLab CI/CD Pipeline for robotframework-chat
# Works with shell executor on any OS (macOS, Linux)
# Assumes tools are pre-installed on runner
#
# Three pipeline modes:
#   1. Regular  -- runs automatically on push/MR, one default model per suite
#   2. Dynamic  -- manual play-button, discovers Ollama nodes on the network,
#                  enumerates models, and runs every (node, model, suite) combo
#   3. Schedule -- hourly cron trigger runs the dynamic pipeline automatically
#
# All modes are generated from config/test_suites.yaml via
# scripts/generate_pipeline.py so test-suite definitions stay DRY.

stages:
  - sync
  - lint
  - review
  - generate
  - test
  - report
  - deploy

variables:
  # Ollama configuration
  OLLAMA_ENDPOINT: "http://localhost:11434"
  DEFAULT_MODEL: "llama3"

  # Test configuration
  ROBOT_OPTIONS: "--metadata CI:true --metadata GitLab_URL:$CI_PROJECT_URL --metadata Commit_SHA:$CI_COMMIT_SHA"

  # Database for test result archiving
  # Set DATABASE_URL in GitLab CI/CD variables to archive to PostgreSQL.
  # When unset the DbListener archives to local SQLite automatically.
  # DATABASE_URL: "postgresql://rfc:rfc@postgres:5432/rfc"


# =============================================================================
# SYNC STAGE - Syncs repos so all CI runs
# =============================================================================
mirror-to-github:
  stage: sync
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - when: manual
  script:
    - git clone --mirror "$CI_REPOSITORY_URL" repo.git
    - cd repo.git
    - git remote add github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/${GITHUB_USER}/${CI_PROJECT_NAME}.git"
    - git push github --mirror --force

# =============================================================================
# LINT STAGE - Uses tools already installed on runner
# =============================================================================

pre-commit:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run pre-commit run --all-files
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

ruff-check:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run ruff check .
    - uv run ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

mypy-check:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run mypy src/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# REVIEW STAGE - AI code review using Claude Code (Opus 4.6)
#
# Runs on merge requests to provide automated code review feedback.
# Requires ANTHROPIC_API_KEY set in GitLab CI/CD variables.
# Reviews follow the project guidelines defined in ai/AGENTS.md and
# ai/REFACTOR.md.
# =============================================================================

claude-code-review:
  stage: review
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    CLAUDE_MODEL: "claude-opus-4-6"
  before_script:
    - npm install -g @anthropic-ai/claude-code
  script:
    - |
      echo "Running Claude Code review on MR !${CI_MERGE_REQUEST_IID}..."
      echo "Model: ${CLAUDE_MODEL}"

      # Collect the MR diff against the target branch
      git fetch origin "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      DIFF=$(git diff "origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}...HEAD")

      if [ -z "$DIFF" ]; then
        echo "No changes detected -- skipping review."
        exit 0
      fi

      # Read project guidelines for the review prompt
      AGENTS_MD=$(cat ai/AGENTS.md)
      REFACTOR_MD=$(cat ai/REFACTOR.md)

      # Run Claude Code in print mode (non-interactive) with Opus 4.6
      REVIEW=$(claude --model "${CLAUDE_MODEL}" --print \
        "You are a senior code reviewer for the robotframework-chat project.

      Review the following merge request diff. Follow the project guidelines
      strictly:

      --- BEGIN ai/AGENTS.md ---
      ${AGENTS_MD}
      --- END ai/AGENTS.md ---

      --- BEGIN ai/REFACTOR.md ---
      ${REFACTOR_MD}
      --- END ai/REFACTOR.md ---

      Review criteria (in priority order):
      1. Correctness: broken tests, logic errors, data loss potential
      2. Security: credential exposure, injection, path traversal
      3. Architecture: adherence to module responsibilities and project structure
      4. Code style: naming, type annotations, Robot Framework syntax conventions
      5. Test coverage: new behavior must have corresponding tests
      6. Commit discipline: atomic commits, proper type prefixes

      For each issue found, state:
      - Severity (must-fix / should-fix / consider)
      - File and approximate location
      - What is wrong and why
      - Suggested fix

      If the diff looks good, say so briefly. Do not invent issues.

      --- BEGIN DIFF ---
      ${DIFF}
      --- END DIFF ---")

      # Save review output as artifact
      echo "${REVIEW}" > claude-review.md
      echo "--- Review complete ---"
      cat claude-review.md

      # Post review as MR comment if GITLAB_TOKEN is available
      if [ -n "$GITLAB_TOKEN" ]; then
        # Wrap review in a collapsible section for cleanliness
        COMMENT_BODY=$(cat <<REVIEW_EOF
      ## Claude Code Review (Opus 4.6)

      <details>
      <summary>Automated review of MR !${CI_MERGE_REQUEST_IID}</summary>

      ${REVIEW}

      </details>

      ---
      *Review generated by Claude Code (\`${CLAUDE_MODEL}\`) following [ai/AGENTS.md](ai/AGENTS.md) and [ai/REFACTOR.md](ai/REFACTOR.md)*
      REVIEW_EOF
      )

        curl --fail --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" \
          --data-urlencode "body=${COMMENT_BODY}" \
          && echo "Review posted to MR." \
          || echo "Warning: could not post review comment to MR."
      else
        echo "GITLAB_TOKEN not set -- review saved as artifact only."
      fi
  artifacts:
    paths:
      - claude-review.md
    expire_in: 30 days
  allow_failure: true

# =============================================================================
# GENERATE STAGE
#
# Reads config/test_suites.yaml and produces child-pipeline YAML.
# Two jobs: one for the regular (automatic) pipeline, one for the
# dynamic (manual) Ollama-discovery pipeline.
# =============================================================================

generate-regular-pipeline:
  stage: generate
  before_script:
    - uv sync --extra dev
  script:
    - uv run python scripts/generate_pipeline.py --mode regular -o generated-pipeline.yml
    - cat generated-pipeline.yml
  artifacts:
    paths:
      - generated-pipeline.yml
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Dynamic Ollama discovery -- manual play button or hourly schedule
#
# Set OLLAMA_NODES (comma-separated host:port) or OLLAMA_SUBNET (CIDR)
# in GitLab CI/CD variables to control which nodes are scanned.
# When neither is set the script falls back to localhost:11434.
generate-dynamic-pipeline:
  stage: generate
  allow_failure: true
  timeout: 60 minutes
  before_script:
    - uv sync --extra dev
  script:
    - echo "Discovering Ollama nodes..."
    - uv run python scripts/discover_ollama.py --pretty
    - uv run python scripts/generate_pipeline.py --mode dynamic -o generated-dynamic-pipeline.yml
    - cat generated-dynamic-pipeline.yml
  artifacts:
    paths:
      - generated-dynamic-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true

# =============================================================================
# TEST STAGE - child pipelines generated above
#
# Every robot run attaches both listeners:
#   - DbListener:          archives per-suite results to PostgreSQL or SQLite
#   - CiMetadataListener:  adds CI context to Robot Framework output
#
# The child pipeline YAML is self-contained (test + report stages).
# =============================================================================

run-regular-tests:
  stage: test
  needs:
    - job: generate-regular-pipeline
      artifacts: true
  trigger:
    include:
      - artifact: generated-pipeline.yml
        job: generate-regular-pipeline
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

run-dynamic-tests:
  stage: test
  needs:
    - job: generate-dynamic-pipeline
      artifacts: true
  trigger:
    include:
      - artifact: generated-dynamic-pipeline.yml
        job: generate-dynamic-pipeline
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true
  allow_failure: true

# =============================================================================
# REPORT STAGE - Repo metrics (lines of code / filesize timeline)
#
# Samples commits across the repo history, counts lines and file sizes
# by type (.py, .robot, other), and generates a timeline plot.
# Posts a Markdown summary as an MR comment when GITLAB_TOKEN is set.
# =============================================================================

repo-metrics:
  stage: report
  needs: []          # no dependencies -- start immediately
  before_script:
    - uv sync
    - uv pip install matplotlib
  script:
    - uv run python scripts/repo_metrics.py -o metrics
    # Post summary as MR note (requires GITLAB_TOKEN with api scope)
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ] && [ -n "$GITLAB_TOKEN" ]; then
        curl --fail --request POST \
          --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes" \
          --data-urlencode "body@metrics/summary.md" \
          && echo "MR comment posted." \
          || echo "Warning: could not post MR comment."
      fi
  artifacts:
    paths:
      - metrics/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# DEPLOY STAGE - Deploy / update Superset stack
#
# Runs only on the default branch when SUPERSET_DEPLOY_HOST is configured.
# Requires a runner with SSH access to the deploy target.
# =============================================================================

deploy-superset:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $SUPERSET_DEPLOY_HOST
  script:
    - |
      echo "Deploying Superset stack to $SUPERSET_DEPLOY_HOST ..."
      ssh "$SUPERSET_DEPLOY_USER@$SUPERSET_DEPLOY_HOST" \
        "cd $SUPERSET_DEPLOY_PATH && git pull && docker compose -f docker-compose.yml up -d --pull always"
  allow_failure: true
