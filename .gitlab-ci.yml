# GitLab CI/CD Pipeline for robotframework-chat
# Works with shell executor on any OS (macOS, Linux)
# Assumes tools are pre-installed on runner

stages:
  - sync
  - lint
  - test
  - report
  - deploy

variables:
  # Ollama configuration
  OLLAMA_ENDPOINT: "http://localhost:11434"
  DEFAULT_MODEL: "llama3"

  # Test configuration
  ROBOT_OPTIONS: "--metadata CI:true --metadata GitLab_URL:$CI_PROJECT_URL --metadata Commit_SHA:$CI_COMMIT_SHA"

  # Database for test result archiving
  # Set DATABASE_URL in GitLab CI/CD variables to archive to PostgreSQL.
  # When unset the DbListener archives to local SQLite automatically.
  # DATABASE_URL: "postgresql://rfc:rfc@postgres:5432/rfc"


## =============================================================================
# SYNC STAGE - Syncs repos so all CI runs
## =============================================================================
mirror-to-github:
  stage: sync
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - when: manual
  script:
    - git clone --mirror "$CI_REPOSITORY_URL" repo.git
    - cd repo.git
    - git remote add github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/${GITHUB_USER}/${CI_PROJECT_NAME}.git"
    - git push github --mirror --force

# =============================================================================
# LINT STAGE - Uses tools already installed on runner
# =============================================================================

pre-commit:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run pre-commit run --all-files
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

ruff-check:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run ruff check .
    - uv run ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

mypy-check:
  stage: lint
  before_script:
    - uv sync --extra dev
  script:
    - uv run mypy src/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# =============================================================================
# TEST STAGE - Requires runner with 'ollama' tag
#
# Every robot run attaches the DbListener which archives results to:
#   - PostgreSQL when DATABASE_URL is set (Superset reads from here)
#   - SQLite (data/test_history.db) otherwise
# =============================================================================

.robot_template: &robot_template
  tags:
    - ollama
  before_script:
    - uv sync --extra dev --extra superset
    - |
      echo "Checking Ollama at $OLLAMA_ENDPOINT..."
      if curl -s "$OLLAMA_ENDPOINT/api/tags" > /dev/null; then
        echo "Ollama is available"
      else
        echo "Warning: Ollama not available - tests may fail"
      fi

robot-math-tests:
  stage: test
  <<: *robot_template
  script:
    - uv run robot -d results/math --listener rfc.db_listener.DbListener -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT -v DEFAULT_MODEL:$DEFAULT_MODEL robot/math/tests/
  artifacts:
    when: always
    paths:
      - results/math/
      - data/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

robot-docker-tests:
  stage: test
  <<: *robot_template
  script:
    - uv run robot -d results/docker --listener rfc.db_listener.DbListener -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT -v DEFAULT_MODEL:$DEFAULT_MODEL robot/docker/
  artifacts:
    when: always
    paths:
      - results/docker/
      - data/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

robot-safety-tests:
  stage: test
  <<: *robot_template
  script:
    - uv run robot -d results/safety --listener rfc.db_listener.DbListener -v OLLAMA_ENDPOINT:$OLLAMA_ENDPOINT -v DEFAULT_MODEL:$DEFAULT_MODEL robot/safety/
  artifacts:
    when: always
    paths:
      - results/safety/
      - data/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# =============================================================================
# REPORT STAGE
# =============================================================================

aggregate-results:
  stage: report
  needs:
    - job: robot-math-tests
      artifacts: true
      optional: true
    - job: robot-docker-tests
      artifacts: true
      optional: true
    - job: robot-safety-tests
      artifacts: true
      optional: true
  before_script:
    - uv sync --extra dev
  script:
    - mkdir -p results/aggregated
    - uv run python scripts/generate_ci_metadata.py || echo "Metadata generation skipped"
  artifacts:
    when: always
    paths:
      - results/aggregated/
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Re-import from output.xml as a safety net (e.g. if listener failed or
# results need to be backfilled into a different database).
archive-results:
  stage: report
  needs:
    - job: robot-math-tests
      artifacts: true
      optional: true
    - job: robot-docker-tests
      artifacts: true
      optional: true
    - job: robot-safety-tests
      artifacts: true
      optional: true
  before_script:
    - uv sync --extra dev --extra superset
  script:
    - |
      if [ -z "$DATABASE_URL" ]; then
        echo "DATABASE_URL not set - skipping XML re-import (listener already archived to SQLite)"
        exit 0
      fi
    - uv run python scripts/import_test_results.py results/ -r --model "$DEFAULT_MODEL" || echo "XML re-import failed"
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# =============================================================================
# DEPLOY STAGE - Deploy / update Superset stack
#
# Runs only on the default branch when SUPERSET_DEPLOY_HOST is configured.
# Requires a runner with SSH access to the deploy target.
# =============================================================================

deploy-superset:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $SUPERSET_DEPLOY_HOST
  script:
    - |
      echo "Deploying Superset stack to $SUPERSET_DEPLOY_HOST ..."
      ssh "$SUPERSET_DEPLOY_USER@$SUPERSET_DEPLOY_HOST" \
        "cd $SUPERSET_DEPLOY_PATH && git pull && docker compose -f docker-compose.yml up -d --pull always"
  allow_failure: true
