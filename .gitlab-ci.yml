# .gitlab-ci.yml - Bare-bones pipeline skeleton
#
# All logic lives in ci/*.sh scripts and Makefile targets.
# This file is intentionally minimal. To modify pipeline behavior,
# edit the scripts -- not this file.
#
# Pipeline modes:
#   1. Regular  - every push/MR, smoke-test with default model
#   2. Dynamic  - manual or scheduled, full node/model matrix
#   3. Schedule - hourly cron triggers dynamic pipeline
#   4. Release  - clean semver tag (v1.2.3), build + publish to PyPI
#   5. Test Release - pre-release tag (v1.2.3-rc1), build + verify only
#
# See: ai/PIPELINES.md

include:
  - local: ci/common.yml

stages:
  - lint
  - generate
  - test
  - report
  - deploy
  - release
  - review

variables:
  OLLAMA_ENDPOINT: "http://localhost:11434"
  DEFAULT_MODEL: "llama3"
  ROBOT_OPTIONS: "--metadata CI:true"

# ── Lint ─────────────────────────────────────────────────────────────

lint:
  extends: .uv-setup
  stage: lint
  script: [bash ci/lint.sh]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG =~ /^v/
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

# ── Generate ─────────────────────────────────────────────────────────

generate-regular-pipeline:
  extends: .uv-setup
  stage: generate
  script: [bash ci/generate.sh regular]
  artifacts:
    paths: [generated-pipeline.yml]
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

discover-nodes:
  extends: .uv-setup
  stage: generate
  script: [bash ci/generate.sh discover]
  artifacts:
    paths: [config/nodes_inventory.yaml]
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true
  allow_failure: true

generate-dynamic-pipeline:
  extends: .uv-setup
  stage: generate
  needs:
    - job: discover-nodes
      artifacts: true
      optional: true
  script: [bash ci/generate.sh dynamic]
  artifacts:
    paths: [generated-dynamic-pipeline.yml]
    expire_in: 7 days
  timeout: 60 minutes
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true
  allow_failure: true

# ── Test ─────────────────────────────────────────────────────────────

# Dashboard unit tests (pytest) - no Ollama/LLM dependency
dashboard-pytest:
  extends: .uv-setup
  stage: test
  needs: []
  tags: [nodejs]
  before_script:
    - uv sync --extra dev --extra dashboard
  script: [bash ci/test_dashboard.sh pytest]
  artifacts:
    when: always
    paths:
      - results/dashboard/
    reports:
      junit: results/dashboard/pytest-results.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG =~ /^v/
    - if: $CI_COMMIT_BRANCH
  allow_failure: false

# Dashboard browser self-tests (Robot Framework + Playwright)
dashboard-playwright:
  extends: .uv-setup
  stage: test
  tags: [nodejs]
  needs: []
  before_script:
    - mkdir -p results/dashboard/playwright
    - . ci/ensure_node.sh
    - uv sync --extra dev --extra dashboard
    - uv pip install robotframework-browser
    - uv run rfbrowser init chromium
  script: [bash ci/test_dashboard.sh playwright]
  after_script:
    - mkdir -p results/dashboard/playwright
  artifacts:
    when: always
    paths:
      - results/dashboard/
    reports:
      junit: results/dashboard/playwright/output.xml
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - when: manual
      allow_failure: true
  allow_failure: true

run-regular-tests:
  stage: test
  trigger:
    include:
      - artifact: generated-pipeline.yml
        job: generate-regular-pipeline
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

run-dynamic-tests:
  stage: test
  trigger:
    include:
      - artifact: generated-dynamic-pipeline.yml
        job: generate-dynamic-pipeline
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true
  allow_failure: true

# ── Report ───────────────────────────────────────────────────────────

repo-metrics:
  extends: .uv-setup
  stage: report
  needs: []
  script: [bash ci/report.sh --post-mr]
  artifacts:
    paths: [metrics/]
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ── Deploy ───────────────────────────────────────────────────────────

deploy-superset:
  stage: deploy
  script: [bash ci/deploy.sh]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $SUPERSET_DEPLOY_HOST
  allow_failure: true

# ── Release ──────────────────────────────────────────────────────────

# Test release: any semver tag with a pre-release suffix (v1.2.3-*)
# Builds and verifies the package but does NOT upload to PyPI.
test-release:
  extends: .uv-setup
  stage: release
  needs:
    - job: lint
      artifacts: false
    - job: dashboard-pytest
      artifacts: false
  script: [bash ci/release.sh --dry-run]
  artifacts:
    paths: [dist/]
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+-.+/
  allow_failure: false

# Real release: clean semver tag only (v1.2.3)
# Builds, verifies, and uploads to PyPI.
publish-pypi:
  extends: .uv-setup
  stage: release
  needs:
    - job: lint
      artifacts: false
    - job: dashboard-pytest
      artifacts: false
  script: [bash ci/release.sh]
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  allow_failure: false

# ── Review ───────────────────────────────────────────────────────────

opencode-review:
  stage: review
  tags: [nodejs]
  variables:
    REVIEW_MODEL: "openrouter/moonshotai/kimi-k2.5"
  before_script:
    - npm install -g opencode-ai
  script: [bash ci/review.sh]
  artifacts:
    paths:
      - review-result.md
      - review-fix-attempt.md
      - review-patch-*.diff
    expire_in: 30 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /opencode-review/
    - when: manual
      allow_failure: true
  allow_failure: true
